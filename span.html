<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>藥嚀管 官方網站 Yao NING GUAN OFFICIAL</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" type="image/png" href="https://i.meee.com.tw/ZdDarEK.png"> 
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DJGFDMENC"></script>
  <script type="module" src="css/log.js"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9DJGFDMENC');
  </script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: auto;
    }
    body {
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .page {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      box-sizing: border-box;
      padding: 18px 0;
    }

    .lottery-layout {
      display: flex;
      gap: 28px;
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      justify-content: flex-start;
      align-items: stretch;
      margin-bottom: 24px;
      max-width: 1200px;
      width: 95%;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }
    .lottery-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 5;
      min-width: 0;
    }
    .lottery-card {
      background: #e7e7e7;
      border-radius: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #222;
      font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
    }
    .lottery-title-card {
      height: 70px;
      font-weight: 700;
      background: linear-gradient(90deg, #f9e7c2 0%, #edefe1 100%);
      color: #338a35;
      font-size: 1.35em;
      letter-spacing: 2px;
    }
    .lottery-wheel-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #fff8ec;
      border-radius: 20px;
      box-shadow: 0 2px 12px rgba(37,143,46,0.10);
      padding: 28px;
      margin: 0 auto;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
      position: relative; 
    }
    .lottery-wheel {
      position: relative;
      width: 560px;
      height: 420px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #spinnerArrow {
      position: absolute;
      left: 50%;
      top: 12px; 
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 56px solid #d9534f; 
      transform: translateX(-50%);
      z-index: 20;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
      pointer-events: none;
    }
    #spinnerArrow::before { display: none; }

    canvas#wheelCanvas {
      border-radius: 50%;
      background: transparent;
      box-shadow: transparent;
      width: 100%;
      height: 100%;
      display: block;
      transform-origin: 50% 50%; 
      will-change: transform;
      background-clip: padding-box;
    }
    .lottery-spin-btn {
      position: relative;
      z-index: 10;
      display: block;
      margin: 0 auto 12px;
      background: linear-gradient(90deg, #44b74a 0%, #8ddf91 100%);
      border: none;
      border-radius: 24px;
      font-size: 1.12em;
      font-weight: 700;
      color: #fff;
      padding: 10px 32px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(37,143,46,0.10);
      transition: background 0.2s, box-shadow 0.2s;
      letter-spacing: 1px;
    }
    .lottery-spin-btn:active {
      background: linear-gradient(90deg,#398f3a 0%,#6ec86e 100%);
      box-shadow: 0 1px 4px rgba(37,143,46,0.13);
    }
    .lottery-input-row {
      display: none;
      gap: 8px;
      justify-content: center;
      margin-top: 18px;
      width: 100%;
      align-items: center;
    }
    .lottery-input {
      border: 1.2px solid #b2b2b2;
      border-radius: 7px;
      padding: 6px 8px;
      font-size: 0.88em;
      outline: none;
      transition: border 0.18s;
      flex: 1;
      max-width: 100%;
    }
    .lottery-input:focus {
      border-color: #338a35;
    }
    .lottery-add-btn {
      background: linear-gradient(90deg,#338a35 0%,#a5d4a0 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 10px;
      font-size: 0.88em;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .lottery-add-btn:active {
      background: linear-gradient(90deg,#216f23 0%,#8ed591 100%);
    }
    .lottery-result {
      margin: 12px 0 0 0;
      font-size: 1.12em;
      font-weight: bold;
      color: #338a35;
      text-align: center;
      letter-spacing: 2px;
      text-shadow: 0 1px 4px rgba(122, 193, 105, 0.06);
      min-height: 1.5em;
    }

    .lottery-function {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 34px 0 0 0;
      justify-content: flex-start;
    }
    .lottery-function-card {
      background: #e7e7e7;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #222;
      font-size: 1.13em;
      min-width: 120px;
      min-height: 54px;
      padding: 0 20px;
      font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .lottery-function-card:hover {
      background: #d8eadc;
      box-shadow: 0 4px 16px rgba(37,143,46,0.10);
    }

    .lottery-tool-card {
      box-sizing: border-box;
      flex: 2;
      width: 100%;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      align-items: stretch;
    }
    .lottery-tool-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size:1.02em;
      font-weight:700;
      margin-bottom:12px;
      color:#338a35;
      border-bottom: 1.5px solid #ededed;
      padding-bottom: 6px;
    }
    .lottery-tool-title .title-text {
      font-weight:700;
      color:#338a35;
    }
    #toggleAddBtn {
      background: linear-gradient(90deg,#56ab2f 0%,#8ddf91 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 0.9em;
      cursor: pointer;
      font-weight:700;
    }
    .lottery-tool-list {
      margin: 0;
      padding: 6px 6px;
      line-height: 1.6;
      color: #333;
      font-size: 0.95em;
      box-sizing: border-box;
      max-width: 100%;
      flex: 1;
      min-height: 140px;
      max-height: 320px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .lottery-tool-list li {
      margin-bottom: 7px;
      word-break:break-all;
      overflow-wrap:break-word;
      max-width: 97%;
    }
    .prize-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #eafae6;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 0.92em;
      box-shadow: 0 1px 2px rgba(37,143,46,0.06);
    }
    .prize-list-name {
      font-weight: 600;
      color: #333;
      word-break: break-word;
      margin-right: 10px;
      flex: 1;
    }
    .prize-list-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .prize-list-qty {
      font-weight: 700;
      color: #338a35;
      background: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .prize-list-qty.zero {
      color: #ff5d5d;
      background: #ffefef;
    }
    .prize-list-remove {
      color: #ff5d5d;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: bold;
      padding: 0 4px;
      border-radius: 4px;
      transition: background 0.16s;
    }
    .prize-list-remove:hover {
      background: #ffdede;
    }

    .total-remaining-wrap {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }
    .total-label {
      color: #666;
      font-size: 1.2em;
      font-weight: 800;
      text-align: center;
    }
    .total-circle {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: linear-gradient(180deg,#ffffff 0%,#e7ffe9 100%);
      border: 2px solid #cfecd1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2f8a34;
      font-weight: 900;
      font-size: 1.8em;
      box-shadow: 0 2px 12px rgba(37,143,46,0.08);
    }

    @media (max-width: 1100px) {
      .lottery-wheel {
        width: 460px;
        height: 340px;
      }
      .total-circle {
        width: 90px;
        height: 90px;
        font-size: 1.45em;
      }
      #spinnerArrow {
        border-bottom-width: 48px;
        border-left-width: 10px;
        border-right-width: 10px;
      }
    }

    @media (max-width: 900px) {
      .lottery-layout {
        flex-direction: column;
        gap: 18px;
        padding: 18px 6px;
        align-items: stretch;
        max-width: 99vw;
        height: auto;
        max-height: none;
      }
      .lottery-left {
        flex-direction: column;
        gap: 14px;
        min-width: 0;
        flex: 5;
      }
      .lottery-title-card, .lottery-wheel-container {
        width: 100%;
        min-width: 0;
        font-size: 1.15em;
      }
      .lottery-title-card {
        height: 60px;
      }
      .lottery-wheel-container {
        padding: 18px 8px 14px;
        flex: 1;
      }
      .lottery-wheel {
        width: 380px;
        height: 300px;
      }
      .lottery-tool-card {
        max-width: 100vw;
        padding: 14px 8vw 12px 8vw;
        flex: 2;
      }
      .lottery-tool-list {
        min-height: 120px;
        max-height: 250px;
        flex: 1 1 250px;
      }
      .total-circle {
        width: 80px;
        height: 80px;
      }
      #spinnerArrow {
        top: 10px;
        border-bottom-width: 44px;
        border-left-width: 8px;
        border-right-width: 8px;
      }
    }
    @media (max-width: 600px) {
      .lottery-layout {
        flex-direction: column;
        gap: 10px;
        padding: 8px 6px;
      }
      .lottery-left {
        flex-direction: column;
        gap: 8px;
      }
      .lottery-title-card, .lottery-wheel-container {
        width: 100%;
        min-width: 0;
        font-size: 1em;
      }
      .lottery-title-card {
        height: 40px;
      }
      .lottery-wheel-container {
        padding: 10px 6px 10px;
      }
      .lottery-wheel {
        width: 320px;
        height: 260px;
      }
      .lottery-tool-card {
        max-width: 100vw;
        padding: 8px 4vw 8px 4vw;
      }
      .lottery-tool-list li {
        max-width: 96vw;
      }
      #toggleAddBtn {
        padding: 6px 8px;
      }
      .total-circle {
        width: 66px;
        height: 66px;
        font-size: 1.05em;
      }
      #spinnerArrow {
        top: 8px;
        border-bottom-width: 36px;
        border-left-width: 7px;
        border-right-width: 7px;
      }
    }

    .swal-solid {
      background: #ffffff !important;
      border-radius: 14px !important;
      box-shadow: 0 18px 60px rgba(20,80,20,0.12) !important;
      color: #06380b !important;
      border: 1px solid rgba(0,0,0,0.04) !important;
    }
    .swal-solid .swal2-title {
      color: #06380b !important;
      font-weight: 800 !important;
    }
    .swal-solid .swal2-html-container {
      color: #124a11 !important;
    }
    .swal-solid .swal2-confirm {
      background: linear-gradient(90deg,#44b74a 0%,#8ddf91 100%) !important;
      color: #fff !important;
      border: none !important;
      box-shadow: 0 6px 18px rgba(37,143,46,0.12) !important;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-right-group">
        <a href="index.html" class="navbar-item">HOME</a>
        <a href="function.html" class="navbar-item">功能頁面</a>
        <a href="member.html" class="navbar-item">藥物基本知識</a>
        <a href="set.html" class="navbar-item">架設技術內容</a>
        <a href="span.html" class="navbar-item">抽獎頁面</a>
        <a href="contact.html" class="navbar-item">聯絡我們</a>
      </div>
      <div class="navbar-right">
        <button class="navbar-icon" aria-label="功能選單"></button>
      </div>
    </div>
  </nav>

  <div class="page">
    <div class="lottery-layout">
      <div class="lottery-left">
        <div class="lottery-card lottery-title-card">抽獎轉盤</div>
        <div class="lottery-wheel-container">
          <div class="lottery-wheel" aria-hidden="false">
            <canvas id="wheelCanvas" role="img" aria-label="抽獎轉盤"></canvas>
            <div id="spinnerArrow" aria-hidden="true"></div>
          </div>
          <button class="lottery-spin-btn" id="spinBtn">開始抽獎</button>          
          <div class="lottery-result" id="result" aria-live="polite"></div>
        </div>
      </div>
      
      <div class="lottery-card lottery-tool-card">
        <div class="lottery-tool-title">
          <div class="title-text">獎項清單</div>
          <button id="toggleAddBtn" aria-expanded="false">新增</button>
        </div>
        <div id="prizeListDisplay" class="lottery-tool-list" role="list">
        </div>

        <div class="total-remaining-wrap" id="totalRemainingWrap" aria-hidden="false">
          <div class="total-label" id="totalLabel">總剩餘</div>
          <div class="total-circle" id="totalCircle">0</div>
        </div>
        
        <div class="lottery-input-row" id="inputRow">
          <input type="text" id="prizeNameInput" class="lottery-input" placeholder="輸入獎項名稱..." maxlength="18" style="flex: 2;">
          <input type="number" id="prizeQtyInput" class="lottery-input" placeholder="數量" min="1" style="flex: 1; max-width: 120px;">
          <button class="lottery-add-btn" id="addBtn">加入</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Copyright 2025 藥嚀管 (UI Design David Cao , Coding Setup 、網站架設維護、資安控管 <a href="https://tw.linkedin.com/in/nasirlincy" target="_blank"> Nasir Lin</a>)
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    const MAX_TYPES = 10;
    const COLORS = [
      '#a8e063','#56ab2f','#ffe29f','#eecda3','#f7b42c','#f7797d','#86a8e7','#a8edea',
      '#f5d020','#e1eec3'
    ];
    let prizes = [];
    let spinning = false;
    let wheelRotation = 0; 
    let resultTimeout = null;

    const wheelCanvas = document.getElementById('wheelCanvas');
    const ctx = wheelCanvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const prizeListDisplay = document.getElementById('prizeListDisplay');
    const prizeNameInput = document.getElementById('prizeNameInput');
    const prizeQtyInput = document.getElementById('prizeQtyInput');
    const addBtn = document.getElementById('addBtn');
    const spinBtn = document.getElementById('spinBtn');
    const toggleAddBtn = document.getElementById('toggleAddBtn');
    const inputRow = document.getElementById('inputRow');
    const totalCircle = document.getElementById('totalCircle');    
    const spinnerArrow = document.getElementById('spinnerArrow');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function savePrizes() {
      try {
        const prizesJSON = JSON.stringify(prizes);
        localStorage.setItem('lotteryPrizes', prizesJSON);
        const d = new Date();
        d.setTime(d.getTime() + (365 * 24 * 60 * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = `lotteryPrizes=${encodeURIComponent(prizesJSON)};${expires};path=/;SameSite=Strict`;
      } catch (e) {
        console.error("儲存獎項失敗:", e);
      }
    }

    function loadPrizes() {
      let prizesJSON = null;
      try {
        prizesJSON = localStorage.getItem('lotteryPrizes');
        if (!prizesJSON) {
          let cookieVal = getCookie('lotteryPrizes');
          if (cookieVal) {
            prizesJSON = decodeURIComponent(cookieVal);
          }
        }
        if (prizesJSON) {
          prizes = JSON.parse(prizesJSON);
        } else {
          prizes = [];
        }
      } catch (e) {
        console.error("讀取獎項失敗:", e);
        prizes = [];
      }
    }

    function resizeCanvasForDPR() {
      const dpr = window.devicePixelRatio || 1;
      const cssWidth = wheelCanvas.clientWidth;
      const cssHeight = wheelCanvas.clientHeight;
      if (!cssWidth || !cssHeight) return;
      wheelCanvas.width = Math.round(cssWidth * dpr);
      wheelCanvas.height = Math.round(cssHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function updateTotalRemainingDisplay() {
      const totalRemaining = prizes.reduce((sum, p) => sum + (Number(p.quantity) || 0), 0);
      totalCircle.textContent = totalRemaining;
    }

    function fitTextToWidth(text, maxWidth, fontBase, fontWeight = '700', fontFamily = "'Noto Sans TC', Arial") {
      let fontSize = fontBase;
      ctx.font = fontWeight + " " + fontSize + "px " + fontFamily;
      let width = ctx.measureText(text).width;
      while (width > maxWidth && fontSize > 10) {
        fontSize -= 1;
        ctx.font = fontWeight + " " + fontSize + "px " + fontFamily;
        width = ctx.measureText(text).width;
      }
      if (width <= maxWidth) return { fontSize, text };
      let truncated = text;
      while (truncated.length > 0) {
        truncated = truncated.slice(0, -1);
        const withEll = truncated + '…';
        width = ctx.measureText(withEll).width;
        if (width <= maxWidth) {
          return { fontSize, text: withEll };
        }
      }
      return { fontSize: Math.max(10, fontSize), text: '…' };
    }

    function shadeColor(hex, percent) {
      let num = parseInt(hex.replace('#',''),16), amt = Math.round(2.55 * percent);
      let r = (num >> 16) + amt;
      let g = (num >> 8 & 0x00FF) + amt;
      let b = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (r<255? (r<1?0:r):255)*0x10000 + (g<255? (g<1?0:g):255)*0x100 + (b<255? (b<1?0:b):255)).toString(16).slice(1);
    }

    function drawWheel(wheelItemsSnapshot = null, selectedIndex = null) {
      resizeCanvasForDPR();
      if (!wheelCanvas.clientWidth || !wheelCanvas.clientHeight) return;

      ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);

      const wheelItems = wheelItemsSnapshot || prizes.filter(p => Number(p.quantity) > 0).map(p => ({ name: p.name, quantity: Number(p.quantity) }));
      const totalQuantity = wheelItems.reduce((sum, p) => sum + p.quantity, 0);

      const cssWidth = wheelCanvas.clientWidth;
      const cssHeight = wheelCanvas.clientHeight;
      const centerX = cssWidth / 2;
      const centerY = cssHeight / 2;
      const radius = Math.max(30, Math.min(centerX, centerY) - 8);

      if (totalQuantity === 0) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = "#ececec";
        ctx.fill();
        ctx.font = "700 " + Math.max(16, Math.round(radius * 0.18)) + "px 'Noto Sans TC', Arial";
        ctx.fillStyle = "#b2b2b2";
        ctx.textAlign = "center";
        ctx.fillText("請加入獎項", centerX, centerY + 6);
        ctx.restore();
        updateTotalRemainingDisplay();
        return;
      }

      let currentDrawAngle = -Math.PI / 2;

      for (let i = 0; i < wheelItems.length; i++) {
        const item = wheelItems[i];
        const itemArc = (item.quantity / totalQuantity) * (2 * Math.PI);
        const startAngle = currentDrawAngle;
        const endAngle = currentDrawAngle + itemArc;

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
        ctx.closePath();

        if (selectedIndex !== null && selectedIndex === i) {
          ctx.fillStyle = shadeColor(COLORS[i % COLORS.length], -6);
          ctx.fill();
          ctx.strokeStyle = 'rgba(0,0,0,0.06)';
          ctx.lineWidth = 2;
          ctx.stroke();
        } else {
          ctx.fillStyle = COLORS[i % COLORS.length];
          ctx.fill();
        }
        ctx.restore();

        ctx.save();
        ctx.translate(centerX, centerY);
        const midAngle = startAngle + itemArc / 2;
        ctx.rotate(midAngle);
        ctx.textAlign = "center";

        const prizeName = item.name;
        const textRadius = radius * 0.62;
        const sliceArcLength = Math.max(20, itemArc * textRadius * 0.92);
        const baseFont = prizeName.length > 10 ? Math.max(12, Math.round(radius * 0.12)) : Math.max(14, Math.round(radius * 0.14));
        const fit = fitTextToWidth(prizeName, sliceArcLength, baseFont);

        ctx.font = "700 " + fit.fontSize + "px 'Noto Sans TC', Arial";
        ctx.fillStyle = "#222";
        ctx.globalAlpha = (selectedIndex !== null && selectedIndex !== i) ? 0.75 : 1.0;
        ctx.fillText(fit.text, textRadius, Math.max(6, radius * 0.03));
        ctx.restore();

        currentDrawAngle = endAngle;
      }

      updateTotalRemainingDisplay();
    }

    function updatePrizeListDisplay() {
      prizeListDisplay.innerHTML = '';
      if (prizes.length === 0) {
        const emptyEl = document.createElement('div');
        emptyEl.textContent = '尚未新增獎項';
        emptyEl.style.textAlign = 'center';
        emptyEl.style.color = '#888';
        emptyEl.style.padding = '10px 0';
        prizeListDisplay.appendChild(emptyEl);
        updateTotalRemainingDisplay();
        return;
      }
      prizes.forEach((prize, idx) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'prize-list-item';
        const nameEl = document.createElement('span');
        nameEl.className = 'prize-list-name';
        nameEl.textContent = prize.name;
        const rightGroup = document.createElement('div');
        rightGroup.className = 'prize-list-right';
        const qtyEl = document.createElement('span');
        qtyEl.className = 'prize-list-qty';
        qtyEl.textContent = `剩 ${prize.quantity}`;
        if (Number(prize.quantity) === 0) {
          qtyEl.classList.add('zero');
        }
        const removeBtn = document.createElement('button');
        removeBtn.className = 'prize-list-remove';
        removeBtn.innerHTML = '✕';
        removeBtn.title = '移除';
        removeBtn.onclick = () => {
          if (spinning) return;
          prizes.splice(idx, 1);
          savePrizes();
          drawWheel();
          updatePrizeListDisplay();
          resultDiv.textContent = '';
        };
        rightGroup.appendChild(qtyEl);
        rightGroup.appendChild(removeBtn);
        itemEl.appendChild(nameEl);
        itemEl.appendChild(rightGroup);
        prizeListDisplay.appendChild(itemEl);
      });
      updateTotalRemainingDisplay();
    }

    addBtn.onclick = () => {
      const name = prizeNameInput.value.trim();
      const quantity = parseInt(prizeQtyInput.value);
      if (!name || !quantity || quantity < 1) {
        Swal.fire({
          icon: 'warning',
          title: '輸入錯誤',
          text: '請輸入有效的獎項名稱與大於 0 的數量！',
          confirmButtonText: '確定',
          customClass: { popup: 'swal-solid' }
        });
        return;
      }
      if (prizes.length >= MAX_TYPES) {
        Swal.fire({
          icon: 'info',
          title: '上限',
          text: '最多只能加入 ' + MAX_TYPES + ' 種獎項！',
          confirmButtonText: '確定',
          customClass: { popup: 'swal-solid' }
        });
        return;
      }
      if (prizes.some(p => p.name === name)) {
        Swal.fire({
          icon: 'info',
          title: '名稱重複',
          text: '該獎項名稱已存在！',
          confirmButtonText: '確定',
          customClass: { popup: 'swal-solid' }
        });
        return;
      }
      prizes.push({ name, quantity });
      savePrizes();
      prizeNameInput.value = '';
      prizeQtyInput.value = '';
      drawWheel();
      updatePrizeListDisplay();
      
      if (typeof logPrizeAdded === 'function') logPrizeAdded(name, quantity, prizes);

      resultDiv.textContent = '';
      prizeNameInput.focus();
    };

    prizeNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') prizeQtyInput.focus();
    });
    prizeQtyInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addBtn.click();
    });

    function toPositiveTwoPi(a) {
      const twoPi = 2 * Math.PI;
      return ((a % twoPi) + twoPi) % twoPi;
    }

    function getIndexFromPointerAngle(wheelItemsSnapshot, pointerAngle) {
      const total = wheelItemsSnapshot.reduce((s, it) => s + it.quantity, 0);
      let cumulative = -Math.PI / 2;
      const normPointer = toPositiveTwoPi(pointerAngle);

      for (let i = 0; i < wheelItemsSnapshot.length; i++) {
        const itemArc = (wheelItemsSnapshot[i].quantity / total) * (2 * Math.PI);
        let start = toPositiveTwoPi(cumulative);
        let end = toPositiveTwoPi(cumulative + itemArc);
        if (start < end) {
          if (normPointer >= start && normPointer < end) return i;
        } else {
          
          if (normPointer >= start || normPointer < end) return i;
        }
        cumulative += itemArc;
      }
      return -1;
    }

    spinBtn.onclick = () => {
      if (spinning) return;
      const wheelItems = prizes.filter(p => Number(p.quantity) > 0).map(p => ({ name: p.name, quantity: Number(p.quantity) }));
      if (wheelItems.length === 0) {
        Swal.fire({
          icon: 'info',
          title: '無可抽獎項',
          text: '已無剩餘獎品可抽！請先新增獎項或補貨。',
          confirmButtonText: '確定',
          customClass: { popup: 'swal-solid' }
        });
        return;
      }

      const wheelItemsSnapshot = wheelItems.slice();

      const totalQuantity = wheelItemsSnapshot.reduce((sum, p) => sum + p.quantity, 0);
      let randomTicket = Math.random() * totalQuantity;
      let selectedIndex = -1;
      let winningPrizeData = null;
      let cumulativeQty = 0;
      for (let i = 0; i < wheelItemsSnapshot.length; i++) {
        cumulativeQty += wheelItemsSnapshot[i].quantity;
        if (randomTicket < cumulativeQty) {
          selectedIndex = i;
          winningPrizeData = wheelItemsSnapshot[i];
          break;
        }
      }
      if (selectedIndex === -1 || !winningPrizeData) {
        console.error("未能選中獎品。抽獎邏輯可能存在問題。");
        return;
      }

      let cumulativeArc = -Math.PI / 2;
      let startAngleOfWinningSlice = 0;
      let arcOfWinningSlice = 0;
      for (let i = 0; i < wheelItemsSnapshot.length; i++) {
        const itemArc = (wheelItemsSnapshot[i].quantity / totalQuantity) * (2 * Math.PI);
        if (i === selectedIndex) {
          startAngleOfWinningSlice = cumulativeArc;
          arcOfWinningSlice = itemArc;
          break;
        }
        cumulativeArc += itemArc;
      }

      const middleAngleOfWinningSlice = startAngleOfWinningSlice + arcOfWinningSlice / 2;
      const randomOffset = (Math.random() - 0.5) * (arcOfWinningSlice * 0.8);
      const finalTargetAngle = middleAngleOfWinningSlice + randomOffset;

      const rounds = 6 + Math.floor(Math.random() * 2);
      
      const wheelTargetForSlice = -Math.PI / 2 - middleAngleOfWinningSlice;
      const finalWheelRotation = 2 * Math.PI * rounds + wheelTargetForSlice + randomOffset * -1; 

      const current = wheelRotation;
      const duration = 2500 + Math.random() * 500;
      let startTime = null;

      spinning = true;
      addBtn.disabled = true;
      spinBtn.disabled = true;
      document.querySelectorAll('.prize-list-remove').forEach(btn => btn.disabled = true);

      drawWheel(wheelItemsSnapshot, null);

      function animateWheel(ts) {
        if (!startTime) startTime = ts;
        let progress = (ts - startTime) / duration;
        if (progress > 1) progress = 1;
        let ease = (1 - Math.cos(Math.PI * progress)) / 2;
        wheelRotation = current + (finalWheelRotation - current) * ease;

        wheelCanvas.style.transform = `rotate(${wheelRotation}rad)`;

        const pointerAngle = toPositiveTwoPi(-Math.PI / 2 - wheelRotation);
        const indexUnderPointer = getIndexFromPointerAngle(wheelItemsSnapshot, pointerAngle);

        drawWheel(wheelItemsSnapshot, indexUnderPointer);

        if (progress < 1) {
          requestAnimationFrame(animateWheel);
        } else {
          
          wheelRotation = finalWheelRotation % (2 * Math.PI);
          wheelCanvas.style.transform = `rotate(${wheelRotation}rad)`;

          const finalPointerAngle = toPositiveTwoPi(-Math.PI / 2 - wheelRotation);
          const finalIndex = getIndexFromPointerAngle(wheelItemsSnapshot, finalPointerAngle);

          spinning = false;
          addBtn.disabled = false;
          spinBtn.disabled = false;
          document.querySelectorAll('.prize-list-remove').forEach(btn => btn.disabled = false);

          if (resultTimeout) clearTimeout(resultTimeout);
          resultTimeout = setTimeout(() => {
            
            resultDiv.textContent = "🎉 結果：" + winningPrizeData.name + " 🎉";

            
            let originalPrize = prizes.find(p => p.name === winningPrizeData.name);
            if (originalPrize && Number(originalPrize.quantity) > 0) {
              originalPrize.quantity = Number(originalPrize.quantity) - 1;
            }
            savePrizes();

            if (typeof logPrizeWon === 'function') logPrizeWon(winningPrizeData.name, prizes);

            updatePrizeListDisplay();
            Swal.fire({
              title: '恭喜你！',
              html: '<div style="margin-top:8px;font-weight:800;font-size:1.15em;color:#1f7a33;">' + winningPrizeData.name + '</div>',
              icon: 'success',
              confirmButtonText: '確定',
              customClass: { popup: 'swal-solid' }
            });
          }, 260);
        }
      }

      requestAnimationFrame(animateWheel);
    };

    toggleAddBtn.addEventListener('click', () => {
      const expanded = toggleAddBtn.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        inputRow.style.display = 'none';
        toggleAddBtn.setAttribute('aria-expanded', 'false');
        toggleAddBtn.textContent = '新增';
      } else {
        inputRow.style.display = 'flex';
        toggleAddBtn.setAttribute('aria-expanded', 'true');
        toggleAddBtn.textContent = '收起';
        prizeNameInput.focus();
      }
    });

    window.addEventListener('resize', () => {
      resizeCanvasForDPR();
      drawWheel();
    });

    
    loadPrizes();
    setTimeout(() => {
      resizeCanvasForDPR();
      drawWheel();
      updatePrizeListDisplay();
      if (typeof logPageView === 'function') logPageView(prizes);
    }, 50);
  </script>
</body>
</html>